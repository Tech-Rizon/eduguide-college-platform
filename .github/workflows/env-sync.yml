name: Sync Environment Variables

# Manually trigger to push GitHub secrets to Vercel environments
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target Vercel environment"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - preview
          - development

jobs:
  sync-env:
    runs-on: ubuntu-latest
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Sync env variables to Vercel (${{ inputs.environment }})
        run: |
          ENV="${{ inputs.environment }}"
          TOKEN="${{ secrets.VERCEL_TOKEN }}"

          sync_var() {
            local name="$1"
            local value="$2"
            if [ -n "$value" ]; then
              # Remove existing, then add fresh
              vercel env rm "$name" "$ENV" --yes --token="$TOKEN" 2>/dev/null || true
              echo "$value" | vercel env add "$name" "$ENV" --token="$TOKEN" --force 2>/dev/null || true
              echo "Synced $name to $ENV"
            else
              echo "Skipped $name (empty/not set)"
            fi
          }

          echo "=== Syncing env vars to Vercel ($ENV) ==="

          sync_var "NEXT_PUBLIC_SUPABASE_URL" "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}"
          sync_var "NEXT_PUBLIC_SUPABASE_ANON_KEY" "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}"
          sync_var "SUPABASE_URL" "${{ secrets.SUPABASE_URL }}"
          sync_var "SUPABASE_SERVICE_ROLE_KEY" "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          sync_var "STRIPE_SECRET_KEY" "${{ secrets.STRIPE_SECRET_KEY }}"
          sync_var "STRIPE_WEBHOOK_SECRET" "${{ secrets.STRIPE_WEBHOOK_SECRET }}"
          sync_var "NEXT_PUBLIC_STRIPE_PRICE_BASIC" "${{ secrets.NEXT_PUBLIC_STRIPE_PRICE_BASIC }}"
          sync_var "NEXT_PUBLIC_STRIPE_PRICE_PREMIUM" "${{ secrets.NEXT_PUBLIC_STRIPE_PRICE_PREMIUM }}"
          sync_var "NEXT_PUBLIC_STRIPE_PRICE_ELITE" "${{ secrets.NEXT_PUBLIC_STRIPE_PRICE_ELITE }}"
          sync_var "NEXT_PUBLIC_SITE_URL" "${{ secrets.NEXT_PUBLIC_SITE_URL }}"
          sync_var "SENDGRID_API_KEY" "${{ secrets.SENDGRID_API_KEY }}"
          sync_var "CONTACT_TO_EMAIL" "${{ secrets.CONTACT_TO_EMAIL }}"
          sync_var "ADMIN_BOOTSTRAP_TOKEN" "${{ secrets.ADMIN_BOOTSTRAP_TOKEN }}"
          sync_var "ADMIN_SEED_EMAIL" "${{ secrets.ADMIN_SEED_EMAIL }}"
          sync_var "ADMIN_SEED_PASSWORD" "${{ secrets.ADMIN_SEED_PASSWORD }}"

          echo "=== Sync complete ==="

      - name: Verify Vercel env variables
        run: |
          echo "Current Vercel env variables for ${{ inputs.environment }}:"
          vercel env ls ${{ inputs.environment }} --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || echo "Could not list env variables"
